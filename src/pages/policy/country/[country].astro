---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import PolicyCard from '../../../components/PolicyCard.astro';
import RadarChart from '../../../components/RadarChart.astro';

export async function getStaticPaths() {
  const allPolicies = await getCollection('policies_zh');
  const countries = [...new Set(allPolicies.map((p) => p.data.country))];

  return countries.map((country) => {
    const countryPolicies = allPolicies.filter(
      (p) => p.data.country === country
    );
    return {
      params: { country },
      props: { policies: countryPolicies },
    };
  });
}

const { country } = Astro.params;
const { policies } = Astro.props;

// --- 治理体系能力聚合逻辑 (FSRTM Systemic Capacity) ---
// 逻辑：取该国家所有政策在各维度的最大值，且保底 30 分
const aggregateScore = (dimension: string) => {
  const scores = policies.map(p => p.data.analysis?.[dimension]?.score || 0);
  const maxScore = Math.max(...scores);
  return Math.max(30, maxScore); // 默认最低分 30
};

const systemicFSRTM = {
  incentive: aggregateScore('incentive'),
  statutory: aggregateScore('statutory'),
  market: aggregateScore('market'),
  strategic: aggregateScore('strategic'),
  mrv: aggregateScore('mrv')
};
---

<Layout 
  title={`${country} CCUS 治理能力审计`}
  description={`深入分析 ${country} 的 CCUS 政策框架，基于 FSRTM 5.0 体系评估其在激励、法律、责任、技术及市场维度的治理成熟度。`}
  keywords={`${country} CCUS, 政策审计, FSRTM 评分, 治理成熟度, 碳捕集`}
>
  <nav class="mb-8">
    <a
      href="/ccus-policy-hub/policy/"
      class="text-blue-600 hover:underline flex items-center gap-2 text-sm"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"><path d="m15 18-6-6 6-6"></path></svg
      >
      返回全球政策库
    </a>
  </nav>

  <header class="mb-12 grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
    <div class="lg:col-span-2">
      <div class="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs font-bold mb-4">
        治理体系审计 (Governance 5.0)
      </div>
      <h1 class="text-4xl font-extrabold mb-4">{country} CCUS 治理能力分析</h1>
      <p class="text-slate-600 dark:text-slate-400 max-w-2xl text-lg">
        当前基于收录的 {policies.length} 条政策进行系统性评估。该国家的治理能力由其各维度下的最先进政策工具（最高分）决定。
      </p>
    </div>
    <div class="h-64">
      <RadarChart data={systemicFSRTM} />
    </div>
  </header>

  <section>
    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
      支撑政策矩阵
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {policies.map((policy) => <PolicyCard policy={policy} lang="zh" />)}
    </div>
  </section>
</Layout>
