---
interface Props {
  id?: string;
  labels?: string[];
  data: {
    incentive: number;
    statutory: number;
    market: number;
    strategic: number;
    mrv: number;
  };
  details?: {
    incentive?: string;
    statutory?: string;
    market?: string;
    strategic?: string;
    mrv?: string;
  };
}

const { data, details, id = 'fsrtmChart', labels = ['Incentive', 'Regulatory', 'Market', 'Strategic', 'Technical'] } = Astro.props;
---

<div class="relative w-full h-full min-h-[200px]">
  <canvas id={id}></canvas>
</div>

<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script is:inline define:vars={{ chartData: data, chartDetails: details, canvasId: id, chartLabels: labels }}>
  const ctx = document.getElementById(canvasId);
  if (ctx) {
    const labelMapping = {
      [chartLabels[0]]: 'incentive',
      [chartLabels[1]]: 'statutory',
      [chartLabels[2]]: 'market',
      [chartLabels[3]]: 'strategic',
      [chartLabels[4]]: 'mrv'
    };

    // Calculate dynamic color based on average score
    const avgScore = (chartData.incentive + chartData.statutory + chartData.market + chartData.strategic + chartData.mrv) / 5;
    const isHighMaturity = avgScore > 70;
    const themeColor = isHighMaturity ? 'rgb(37, 99, 235)' : 'rgb(245, 158, 11)';
    const bgColor = isHighMaturity ? 'rgba(37, 99, 235, 0.1)' : 'rgba(245, 158, 11, 0.1)';

    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: chartLabels,
        datasets: [{
          data: [
            chartData.incentive,
            chartData.statutory,
            chartData.market,
            chartData.strategic,
            chartData.mrv
          ],
          fill: true,
          backgroundColor: bgColor,
          borderColor: themeColor,
          borderWidth: 3,
          pointRadius: 4,
          pointBackgroundColor: themeColor,
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHitRadius: 15,
          lineTension: 0.15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            angleLines: { color: 'rgba(148, 163, 184, 0.1)' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' },
            pointLabels: { 
              display: true,
              font: { size: 11, weight: '900' },
              color: '#64748b'
            },
            ticks: { 
              display: false,
              stepSize: 25
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            padding: 12,
            cornerRadius: 16,
            displayColors: false,
            callbacks: {
              label: function(context) {
                const label = context.label;
                const value = context.formattedValue;
                const key = labelMapping[label];
                const evidence = chartDetails ? chartDetails[key] : null;
                
                let result = [`Score: ${value}/100`];
                
                if (evidence && evidence !== "No evidence provided yet.") {
                  result.push('');
                  // Improved wrapping logic
                  const words = evidence.split(' ');
                  let currentLine = 'Evidence: ';
                  
                  words.forEach(word => {
                    if ((currentLine + word).length > 35) {
                      result.push(currentLine);
                      currentLine = '  ' + word;
                    } else {
                      currentLine += (currentLine === 'Evidence: ' ? '' : ' ') + word;
                    }
                  });
                  result.push(currentLine);
                }
                
                return result;
              }
            }
          }
        }
      }
    });
  }
</script>