---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// 关键修复：改用 id 前缀判断语言
const policies = await getCollection('policies_zh');
---

<Layout title="政策对比分析">
  <div class="max-w-7xl mx-auto py-8 px-4">
    <div class="print:hidden mb-12 flex justify-between items-end">
      <div>
        <h1 class="text-4xl font-black mb-4 text-slate-900 dark:text-white flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-blue-600"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.83L3 3"/><path d="m15 10.828 5.828-5.828"/><path d="M12 14.172a4 4 0 0 1 1.172-2.828L21 3"/></svg>
          政策对比矩阵
        </h1>
        <p class="text-slate-500 max-w-2xl">选择多项政策进行横向维度对比，支持一键生成专业分析简报与 PDF 导出。</p>
      </div>
      <div class="flex gap-3">
        <button id="clear-all" class="px-4 py-2 text-sm font-bold text-slate-400 hover:text-red-500 transition-colors">
          清空选择
        </button>
        <button id="print-report" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
          导出分析报告 (PDF)
        </button>
      </div>
    </div>

    <div class="hidden print:block mb-12 border-b-4 border-slate-900 pb-8">
      <h1 class="text-4xl font-black text-slate-900 mb-2">CCUS 政策对比分析简报</h1>
      <p class="text-slate-500">生成日期：{new Date().toLocaleDateString('zh-CN')} | 数据来源：CCUS Policy Hub</p>
    </div>

    <div id="compare-container" class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <div class="lg:col-span-3 overflow-x-auto">
        <table id="comparison-matrix" class="w-full border-collapse bg-white dark:bg-slate-900 rounded-3xl overflow-hidden shadow-sm border border-slate-200 dark:border-slate-800">
          <thead>
            <tr id="matrix-header" class="bg-slate-50 dark:bg-slate-800/50">
              <th class="p-6 text-left text-xs font-black uppercase tracking-widest text-slate-400 border-b dark:border-slate-700 w-48 italic">分析维度 Analysis Dimension</th>
            </tr>
          </thead>
          <tbody id="matrix-body" class="divide-y dark:divide-slate-800"></tbody>
        </table>
      </div>

      <div class="lg:col-span-1 space-y-6">
        <div id="briefing-box" class="p-8 bg-blue-50 dark:bg-blue-900/10 rounded-3xl border border-blue-100 dark:border-blue-900/20">
          <h3 class="font-bold text-blue-900 dark:text-blue-300 mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            自动分析简报
          </h3>
          <div id="briefing-content" class="text-sm text-blue-800/80 dark:text-blue-400/80 leading-relaxed space-y-4"></div>
        </div>
      </div>
    </div>

    <div id="empty-state" class="hidden py-32 text-center bg-slate-50 dark:bg-slate-900/50 rounded-[3rem] border-2 border-dashed border-slate-200 dark:border-slate-800">
      <div class="max-w-md mx-auto">
        <h2 class="text-xl font-bold mb-2 dark:text-white">对比矩阵为空</h2>
        <p class="text-slate-500 mb-8">请从政策数据库中选择至少 2 项政策进行深度对标分析。</p>
        <a href="/policy" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold">去政策库选择</a>
      </div>
    </div>
  </div>

  <div id="all-policies-data" data-policies={JSON.stringify(policies)} class="hidden"></div>
</Layout>

<script>
  function renderMatrix() {
    const selectedSlugs = JSON.parse(localStorage.getItem('compare-list') || '[]');
    const allPolicies = JSON.parse((document.getElementById('all-policies-data') as any).dataset.policies);
    
    // 关键修复：selectedSlugs 里的 ID 需要与 policies 里的 id 完全匹配
    const selectedData = allPolicies.filter((p: any) => selectedSlugs.includes(p.id));

    const matrixHeader = document.getElementById('matrix-header');
    const matrixBody = document.getElementById('matrix-body');
    const briefingContent = document.getElementById('briefing-content');
    const emptyState = document.getElementById('empty-state');
    const compareContainer = document.getElementById('compare-container');

    if (selectedData.length === 0) {
      emptyState?.classList.remove('hidden');
      compareContainer?.classList.add('hidden');
      return;
    } else {
      emptyState?.classList.add('hidden');
      compareContainer?.classList.remove('hidden');
    }

    if (matrixHeader) {
      matrixHeader.innerHTML = '<th class="p-6 text-left text-xs font-black uppercase tracking-widest text-slate-400 border-b dark:border-slate-700 w-48 italic">分析维度</th>' + 
        selectedData.map((p: any) => `
          <th class="p-6 text-left border-b dark:border-slate-700 min-w-[240px]">
            <div class="text-[10px] font-black uppercase tracking-widest text-blue-600 mb-1">${p.data.country}</div>
            <div class="font-bold text-slate-900 dark:text-white leading-snug">${p.data.title}</div>
          </th>
        `).join('');
    }

    const dimensions = [
      { label: '政策类别', key: 'category' },
      { label: '激励额度', key: 'incentive_value' },
      { label: '激励期限 (年)', key: 'incentive_duration_years' },
      { label: 'EOR 适用性', key: 'eor_eligibility' },
      { label: '审批前置周期', key: 'permitting_lead_time' },
      { label: 'MRV 严谨度 (1-5)', key: 'mrv_rigor' },
      { label: '长期责任转移期', key: 'liability_period_years' },
      { label: '公众咨询要求', key: 'public_consultation' },
      { label: '孔隙使用权', key: 'pore_space_rights' },
      { label: 'CO2 法律定义', key: 'co2_definition' }
    ];

    if (matrixBody) {
      matrixBody.innerHTML = dimensions.map(dim => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
          <td class="p-6 text-sm font-bold text-slate-500 dark:text-slate-400 bg-slate-50/50 dark:bg-slate-800/20">${dim.label}</td>
          ${selectedData.map((p: any) => {
            const val = p.data[dim.key] || '---';
            const displayVal = dim.isArray ? (Array.isArray(val) ? val.join(', ') : val) : val;
            return `<td class="p-6 text-sm font-medium dark:text-slate-300 leading-relaxed">${displayVal}</td>`;
          }).join('')}
        </tr>
      `).join('');
    }

    if (briefingContent) {
      const countries = [...new Set(selectedData.map((p: any) => p.data.country))];
      briefingContent.innerHTML = `
        <p><b>分析概览：</b>涵盖 <b>${countries.join('、')}</b> 等地区的 <b>${selectedData.length}</b> 项政策。</p>
        <p><b>核心发现：</b>${selectedData.some((p: any) => p.data.incentive_type?.includes('Tax')) ? '包含税收抵免机制。' : '包含直接拨款或CfD机制。'}</p>
      `;
    }
  }

  document.getElementById('clear-all')?.addEventListener('click', () => {
    localStorage.removeItem('compare-list');
    window.dispatchEvent(new CustomEvent('compare-updated'));
    renderMatrix();
  });

  document.getElementById('print-report')?.addEventListener('click', () => window.print());
  window.addEventListener('compare-updated', renderMatrix);
  window.addEventListener('storage', renderMatrix);
  document.addEventListener('astro:page-load', renderMatrix);
  renderMatrix();
</script>
