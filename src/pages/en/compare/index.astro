---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import i18nDict from '../../../data/i18n_dictionary.json';

const allPolicies = await getCollection('policies_en');
const dictCountries: Record<string, string> = i18nDict.countries;

const policies = allPolicies.map(p => ({
  ...p,
  data: {
    ...p.data,
    country: dictCountries[p.data.country] || p.data.country
  }
}));

const allFacilities = (await getCollection('facilities_en')).map(f => ({
  ...f,
  data: {
    ...f.data,
    country: dictCountries[f.data.country] || f.data.country
  }
}));

import countryData from '../../../data/countries.json';
---

<Layout title="Policy Comparison Matrix">
  <div class="max-w-7xl mx-auto py-8 px-4">
    <div class="print:hidden mb-12 flex justify-between items-end">
      <div>
        <h1
          class="text-4xl font-extrabold mb-4 text-slate-900 dark:text-white flex items-center gap-3"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="36"
            height="36"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            class="text-blue-600"
            ><path d="M16 3h5v5"></path><path d="M8 3H3v5"></path><path
              d="M12 22v-8.3a4 4 0 0 0-1.172-2.83L3 3"></path><path
              d="m15 10.828 5.828-5.828"></path><path
              d="M12 14.172a4 4 0 0 1 1.172-2.828L21 3"></path></svg
          >
          Comparison Matrix
        </h1>
        <p class="text-slate-500 max-w-2xl">
          Compare multiple governance systems side-by-side. Analyze peak strengths and regulatory frameworks.
        </p>
      </div>
      <div class="flex gap-3">
        <button
          id="clear-all"
          class="px-4 py-2 text-sm font-bold text-slate-400 hover:text-red-500 transition-colors"
        >
          Clear All
        </button>
        <button
          id="print-report"
          class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            ><path d="M6 9V2h12v7"></path><path
              d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"
            ></path><rect width="12" height="8" x="6" y="14"></rect></svg
          >
          Export Report (PDF)
        </button>
      </div>
    </div>

    <div id="compare-container" class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start">
      <!-- Left: Analytics & Stats -->
      <div class="lg:col-span-5 space-y-8">
        <div class="bg-slate-50 dark:bg-slate-900/50 rounded-[3rem] p-10 border border-slate-100 dark:border-slate-800 shadow-sm sticky top-24">
          <div class="mb-8">
            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-blue-600 mb-2">Governance Benchmarking</h2>
            <h3 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">System Peak Strength</h3>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Multi-Country Aggregate Analysis (Peak Capability)</p>
          </div>
          
          <div class="h-80 w-full mb-8">
            <canvas id="compare-radar-canvas"></canvas>
          </div>

          <!-- Facility Stats Comparison -->
          <div id="facility-stats-compare" class="pt-8 border-t border-slate-200 dark:border-slate-800 space-y-6">
            <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
              Facility Benchmarking
            </h4>
            <div id="stats-grid" class="space-y-4">
              <!-- Stats rows injected here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Contributors & Regulatory Matrix -->
      <div class="lg:col-span-7 space-y-12">
        <!-- Peak Contributors -->
        <section>
          <div class="flex items-center gap-3 mb-8">
            <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400">Governance Peak Contributors</h2>
            <div class="h-px bg-slate-100 dark:bg-slate-800 flex-1"></div>
          </div>
          <div id="policy-bundles-container" class="space-y-10">
            <!-- Bundles per country -->
          </div>
        </section>

        <!-- Regulatory Comparison Matrix -->
        <section class="bg-white dark:bg-slate-950 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 overflow-hidden">
          <div class="p-8 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-800">
            <h3 class="text-xs font-black uppercase tracking-widest text-slate-500">Critical Regulatory Benchmarking</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead id="reg-matrix-header"></thead>
              <tbody id="reg-matrix-body" class="divide-y divide-slate-50 dark:divide-slate-900"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <div
      id="empty-state"
      class="hidden py-32 text-center bg-slate-50 dark:bg-slate-900/50 rounded-[3rem] border-2 border-dashed border-slate-200 dark:border-slate-800"
    >
      <h2 class="text-xl font-bold mb-2">No Policies Selected</h2>
      <p class="text-slate-500 mb-8">
        Please select policies from the database to start national governance analysis.
      </p>
      <a
        href="/ccus-policy-hub/en/policy/"
        class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold"
        >Go to Database</a
      >
    </div>
  </div>

  <div id="all-facilities-data" data-facilities={JSON.stringify(allFacilities)} class="hidden"></div>
  <div id="all-policies-data" data-policies={JSON.stringify(policies)} class="hidden"></div>
  <div id="country-data" data-countries={JSON.stringify(countryData)} class="hidden"></div>
</Layout>

<script>
  import Chart from 'chart.js/auto';

  let currentChart: any = null;
  const escapeHtml = (value: unknown) =>
    String(value ?? '').replace(
      /[&<>"']/g,
      (char) =>
        (
          {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
          } as Record<string, string>
        )[char] || char
    );
  const colors = [
    { border: 'rgb(37, 99, 235)', bg: 'rgba(37, 99, 235, 0.1)' },
    { border: 'rgb(16, 185, 129)', bg: 'rgba(16, 185, 129, 0.1)' },
    { border: 'rgb(245, 158, 11)', bg: 'rgba(245, 158, 11, 0.1)' },
    { border: 'rgb(139, 92, 246)', bg: 'rgba(139, 92, 246, 0.1)' },
    { border: 'rgb(236, 72, 153)', bg: 'rgba(236, 72, 153, 0.1)' }
  ];

  function renderCompareView() {
    const selectedSlugs = JSON.parse(localStorage.getItem('compare-list') || '[]');
    const allPolicies = JSON.parse((document.getElementById('all-policies-data') as any).dataset.policies);
    const allFacilities = JSON.parse((document.getElementById('all-facilities-data') as any).dataset.facilities);
    const countryMap = JSON.parse((document.getElementById('country-data') as any).dataset.countries);
    
    const userSelected = allPolicies.filter((p: any) => selectedSlugs.includes(p.id));
    const selectedCountries = [...new Set(userSelected.map((p: any) => p.data.country))];

    const container = document.getElementById('compare-container');
    const emptyState = document.getElementById('empty-state');
    const bundleContainer = document.getElementById('policy-bundles-container');
    const statsGrid = document.getElementById('stats-grid');
    const regHeader = document.getElementById('reg-matrix-header');
    const regBody = document.getElementById('reg-matrix-body');

    if (selectedCountries.length === 0) {
      emptyState?.classList.remove('hidden');
      container?.classList.add('hidden');
      return;
    } else {
      emptyState?.classList.add('hidden');
      container?.classList.remove('hidden');
    }

    // 1. Group Data by Country and Calculate Peaks
    const countryData = selectedCountries.map((c, idx) => {
      // Improved Mapping: Try to find the display name
      let displayCountry = c as string;
      if (countryMap[displayCountry]?.en) {
        displayCountry = countryMap[displayCountry].en;
      }

      const countryPolicies = allPolicies.filter((p: any) => {
        const pCountry = p.data.country;
        const match = pCountry === c || 
                     (countryMap[pCountry]?.en && countryMap[pCountry].en === countryMap[c as string]?.en);
        return match && (p.data.status === 'Active' || p.data.status === '运行中' || p.data.status === '现行');
      });

      const facilities = allFacilities.filter((f: any) => {
        const fCountry = f.data.country;
        const fCanon = countryMap[fCountry]?.en || fCountry;
        const cCanon = countryMap[c as string]?.en || c;
        return fCanon === cCanon;
      });
      
      const peakAnalysis = {
        incentive: Math.max(...countryPolicies.map((p: any) => p.data.analysis?.incentive?.score || 0), 0),
        statutory: Math.max(...countryPolicies.map((p: any) => p.data.analysis?.statutory?.score || 0), 0),
        market: Math.max(...countryPolicies.map((p: any) => p.data.analysis?.market?.score || 0), 0),
        strategic: Math.max(...countryPolicies.map((p: any) => p.data.analysis?.strategic?.score || 0), 0),
        mrv: Math.max(...countryPolicies.map((p: any) => p.data.analysis?.mrv?.score || 0), 0)
      };

      const contributors = countryPolicies.filter((p: any) => {
        return Object.entries(peakAnalysis).some(([dim, score]) => (p.data.analysis?.[dim]?.score || 0) === score && score > 0);
      }).sort((a:any, b:any) => b.data.year - a.data.year);

      const stats = {
        operational: facilities.filter((f:any) => f.data.status === 'Operational' || f.data.status === '运行中').length,
        operationalCap: facilities.filter((f:any) => f.data.status === 'Operational' || f.data.status === '运行中').reduce((acc:number, f:any) => acc + (f.data.estimatedCapacity || 0), 0),
        constructionCap: facilities.filter((f:any) => f.data.status === 'Under construction' || f.data.status === '建设中').reduce((acc:number, f:any) => acc + (f.data.estimatedCapacity || 0), 0),
        plannedCap: facilities.filter((f:any) => f.data.status === 'Planned' || f.data.status === '计划中').reduce((acc:number, f:any) => acc + (f.data.estimatedCapacity || 0), 0)
      };

      // Aggregate Regulatory Data (take best available values from all country policies)
      const primary: any = {};
      const regFields = [
        'pore_space_rights',
        'liability_transfer',
        'liability_period',
        'financial_assurance',
        'permitting_lead_time',
        'co2_definition',
        'cross_border_rules',
      ];

      // Use all policies for the country to fill the matrix, not just active ones
      const countryPoliciesForAllStatuses = allPolicies.filter((p: any) => {
        const pCountry = p.data.country;
        return pCountry === c || (countryMap[pCountry]?.en && countryMap[pCountry].en === countryMap[c as string]?.en);
      });
      const sortedPolicies = [...countryPoliciesForAllStatuses].sort(
        (a: any, b: any) => b.data.year - a.data.year
      );

      regFields.forEach((field) => {
        for (const p of sortedPolicies) {
          const val = p.data.regulatory?.[field];
          if (val && val !== '' && val !== '---') {
            primary[field] = val;
            break;
          }
        }
      });

      return { country: c, displayCountry, color: colors[idx % colors.length], peakAnalysis, contributors, stats, regulatory: primary };
    });

    // 2. Render Radar Chart
    const ctx = document.getElementById('compare-radar-canvas') as HTMLCanvasElement;
    if (ctx) {
      if (currentChart) currentChart.destroy();
      currentChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Incentive', 'Regulatory', 'Market', 'Strategic', 'Technical'],
          datasets: countryData.map(cd => ({
            label: cd.displayCountry,
            data: [cd.peakAnalysis.incentive, cd.peakAnalysis.statutory, cd.peakAnalysis.market, cd.peakAnalysis.strategic, cd.peakAnalysis.mrv],
            borderColor: cd.color.border,
            backgroundColor: cd.color.bg,
            borderWidth: 3,
            pointRadius: 4,
            fill: true
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
          }
        }
      });
    }

    // 3. Render Bundles
    if (bundleContainer) {
      const dimColors: any = {
        incentive: 'bg-emerald-500',
        statutory: 'bg-blue-500',
        market: 'bg-amber-500',
        strategic: 'bg-purple-500',
        mrv: 'bg-slate-500'
      };

      bundleContainer.innerHTML = countryData.map(cd => `
        <div class="space-y-6">
          <div class="flex items-center gap-4">
            <div class="w-3 h-3 rounded-full" style="background-color: ${cd.color.border}"></div>
            <h3 class="text-xl font-bold dark:text-white">${escapeHtml(cd.displayCountry)} Governance Bundle</h3>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${cd.contributors.map((p: any) => `
              <div class="p-5 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-sm hover:border-blue-500 transition-all relative">
                <div class="flex justify-between items-start mb-3">
                  <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${p.data.year}</span>
                  <div class="flex gap-1">
                    ${['incentive', 'statutory', 'market', 'strategic', 'mrv'].map(dim => {
                      const score = p.data.analysis?.[dim]?.score || 0;
                      const isPeak = score === cd.peakAnalysis[dim as keyof typeof cd.peakAnalysis] && score > 0;
                      return isPeak ? `<span class="w-1.5 h-1.5 rounded-full ${dimColors[dim]}"></span>` : '';
                    }).join('')}
                  </div>
                </div>
                <h4 class="text-sm font-bold text-slate-900 dark:text-white line-clamp-1 mb-4">${escapeHtml(p.data.title)}</h4>
                <div class="flex gap-1.5">
                  ${['incentive', 'statutory', 'market', 'strategic', 'mrv'].map((key) => {
                    const score = p.data.analysis?.[key]?.score || 0;
                    const isPeak = score === cd.peakAnalysis[key as keyof typeof cd.peakAnalysis] && score > 0;
                    const barColor = isPeak ? dimColors[key] : 'bg-slate-200 dark:bg-slate-800';
                    return `
                      <div class="flex-1">
                        <div class="h-1 w-full bg-slate-50 dark:bg-slate-900 rounded-full overflow-hidden mb-1">
                          <div class="h-full ${barColor} transition-all duration-1000" style="width: ${score}%"></div>
                        </div>
                        <div class="text-[7px] font-black text-center ${isPeak ? 'text-slate-900 dark:text-white' : 'text-slate-400 opacity-50'}">${key.substring(0,3).toUpperCase()}</div>
                      </div>
                    `;
                  }).join('')}
                </div>
                <a href="/ccus-policy-hub/en/policy/${encodeURIComponent(String(p.id))}/" class="absolute inset-0"></a>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('<div class="h-px bg-slate-100 dark:bg-slate-800 my-8"></div>');
    }

    // 4. Facility Stats
    if (statsGrid) {
      statsGrid.innerHTML = countryData.map(cd => `
        <div class="p-6 bg-white dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800 rounded-3xl">
          <div class="flex justify-between items-center mb-4">
            <span class="font-bold text-slate-900 dark:text-white">${escapeHtml(cd.displayCountry)}</span>
            <span class="text-[10px] font-black text-blue-600">${cd.stats.operational} Active Projects</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <div class="text-center p-2 rounded-xl bg-slate-50 dark:bg-slate-800/50">
              <p class="text-[8px] font-black text-emerald-500 uppercase">Operational</p>
              <p class="text-xs font-bold dark:text-white">${cd.stats.operationalCap.toFixed(1)}</p>
            </div>
            <div class="text-center p-2 rounded-xl bg-slate-50 dark:bg-slate-800/50">
              <p class="text-[8px] font-black text-amber-500 uppercase">Construction</p>
              <p class="text-xs font-bold dark:text-white">${cd.stats.constructionCap.toFixed(1)}</p>
            </div>
            <div class="text-center p-2 rounded-xl bg-slate-50 dark:bg-slate-800/50">
              <p class="text-[8px] font-black text-blue-500 uppercase">Planned</p>
              <p class="text-xs font-bold dark:text-white">${cd.stats.plannedCap.toFixed(1)}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // 5. Regulatory Matrix
    const regKeys = [
      { label: 'Pore Space Rights', key: 'pore_space_rights' },
      { label: 'Liability Transfer', key: 'liability_transfer' },
      { label: 'Liability Period', key: 'liability_period' },
      { label: 'Financial Assurance', key: 'financial_assurance' },
      { label: 'Permitting Lead Time', key: 'permitting_lead_time' },
      { label: 'CO2 Legal Definition', key: 'co2_definition' },
      { label: 'Cross-border Rules', key: 'cross_border_rules' }
    ];

    if (regHeader) {
      regHeader.innerHTML = `<tr><th class="p-6 text-[10px] font-black uppercase text-slate-400">Dimension</th>` + 
        countryData.map(cd => `<th class="p-6 font-bold text-slate-900 dark:text-white border-l border-slate-100 dark:border-slate-800">${escapeHtml(cd.displayCountry)}</th>`).join('') + `</tr>`;
    }

    if (regBody) {
      regBody.innerHTML = regKeys.map(rk => `
        <tr class="group hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors">
          <td class="p-6 text-xs font-bold text-slate-500 dark:text-slate-400 bg-slate-50/30 dark:bg-slate-900/20">${rk.label}</td>
          ${countryData.map(cd => `<td class="p-6 text-xs text-slate-600 dark:text-slate-400 border-l border-slate-100 dark:border-slate-800 font-medium">${escapeHtml((cd.regulatory as any)[rk.key] || '---')}</td>`).join('')}
        </tr>
      `).join('');
    }
  }

  function initComparePage() {
    const clearBtn = document.getElementById('clear-all') as
      | HTMLButtonElement
      | null;
    if (clearBtn) {
      clearBtn.onclick = () => {
        localStorage.removeItem('compare-list');
        window.dispatchEvent(new CustomEvent('compare-updated'));
        renderCompareView();
      };
    }

    const printBtn = document.getElementById('print-report') as
      | HTMLButtonElement
      | null;
    if (printBtn) {
      printBtn.onclick = () => {
        window.print();
      };
    }

    renderCompareView();
  }

  if (!(window as any).__ccusComparePageBoundEn) {
    window.addEventListener('compare-updated', renderCompareView);
    window.addEventListener('storage', renderCompareView);
    document.addEventListener('astro:page-load', initComparePage);

    if (document.readyState === 'complete') {
      initComparePage();
    } else {
      window.addEventListener('load', initComparePage);
    }

    (window as any).__ccusComparePageBoundEn = true;
  } else {
    initComparePage();
  }
</script>
