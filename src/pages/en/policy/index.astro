---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import PolicyCard from '../../../components/PolicyCard.astro';

// Only fetch English policies
const policies = await getCollection('policies_en');

// Category mapping logic
const categoryMap: Record<string, string> = {
  'Economic Incentive': 'Economic Incentive',
  'Regulatory Framework': 'Regulatory Framework',
  'Market Mechanism': 'Market Mechanism',
  'Strategic Guidance': 'Strategic Guidance',
  'Technical Standard': 'Technical Standard',
  '经济激励': 'Economic Incentive',
  '法律监管': 'Regulatory Framework',
  '市场机制': 'Market Mechanism',
  '战略引导': 'Strategic Guidance',
  '技术规范': 'Technical Standard',
};

const uniqueCountries = Array.from(new Set(policies.map((p) => p.data.country))).sort();
const uniqueSectors = Array.from(new Set(policies.flatMap((p) => p.data.sectors || []))).sort();
const uniqueCategories = Array.from(new Set(policies.map((p) => categoryMap[p.data.category] || p.data.category))).sort();
---

<Layout
  title="Policy Database"
  description="Search and analyze global CCUS policies and regulations across five dimensions: Legal, Economic, Market, Strategic, and Technical."
  keywords="CCUS Policies, Carbon Capture Regulations, Climate Policy Database, Global CCS Incentives"
>
  <div class="mb-10">
    <div class="max-w-2xl mb-8">
      <h1 class="text-4xl font-black mb-4 dark:text-white">Policy Database</h1>
      <p class="text-slate-600 dark:text-slate-400">
        Global CCUS policy repository covering Legal & Regulatory, Economic
        Incentives, Market Mechanisms, Strategic Guidance, and Technical Standards.
      </p>
    </div>

    <div
      class="flex flex-col md:flex-row gap-4 bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm"
    >
      <div class="flex-grow relative">
        <input
          type="text"
          id="search-input"
          placeholder="Search titles, content or tags..."
          class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all dark:text-white"
        />
        <svg
          class="absolute left-3 top-2.5 text-slate-400"
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
          ></path></svg
        >
      </div>

      <select
        id="country-filter"
        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"
      >
        <option value="">All Countries</option>
        {uniqueCountries.map((country) => <option value={country}>{country}</option>)}
      </select>

      <select
        id="industry-filter"
        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"
      >
        <option value="">All Sectors</option>
        {uniqueSectors.map((sector) => <option value={sector}>{sector}</option>)}
      </select>

      <select
        id="category-filter"
        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"
      >
        <option value="">All Categories</option>
        {uniqueCategories.map((cat) => <option value={cat}>{cat}</option>)}
      </select>
    </div>
  </div>

  <div
    id="policy-grid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
  >
    {
      policies
        .sort((a, b) => b.data.year - a.data.year)
        .map((policy) => {
          const displayCategory = categoryMap[policy.data.category] || policy.data.category;
          return (
            <div
              class="policy-item"
              data-title={policy.data.title}
              data-country={policy.data.country}
              data-category={displayCategory}
              data-sectors={policy.data.sectors?.join(',') || ''}
            >
              <PolicyCard policy={policy} lang="en" />
            </div>
          )
        })
    }
  </div>

  <div id="no-results" class="hidden py-20 text-center">
    <p class="text-slate-500">No policies found matching your criteria.</p>
  </div>
</Layout>

<script>
  function setupFiltering() {
    const searchInput = document.getElementById(
      'search-input'
    ) as HTMLInputElement;
    const countryFilter = document.getElementById(
      'country-filter'
    ) as HTMLSelectElement;
    const industryFilter = document.getElementById(
      'industry-filter'
    ) as HTMLSelectElement;
    const categoryFilter = document.getElementById(
      'category-filter'
    ) as HTMLSelectElement;
    const policyItems = document.querySelectorAll('.policy-item');
    const noResults = document.getElementById('no-results');

    function filterPolicies() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const country = countryFilter?.value || '';
      const industry = industryFilter?.value || '';
      const category = categoryFilter?.value || '';

      let visibleCount = 0;

      policyItems.forEach((item) => {
        const htmlItem = item as HTMLElement;
        const title = htmlItem.dataset.title?.toLowerCase() || '';
        const itemCountry = htmlItem.dataset.country || '';
        const itemCategory = htmlItem.dataset.category || '';
        const itemSectors = htmlItem.dataset.sectors || '';

        const matchesSearch = title.includes(searchTerm);
        const matchesCountry = !country || itemCountry === country;
        const matchesCategory = !category || itemCategory === category;
        const matchesIndustry = !industry || itemSectors.split(',').includes(industry);

        if (matchesSearch && matchesCountry && matchesCategory && matchesIndustry) {
          htmlItem.style.display = 'block';
          visibleCount++;
        } else {
          htmlItem.style.display = 'none';
        }
      });

      if (noResults) {
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
      }
    }

    searchInput?.addEventListener('input', filterPolicies);
    countryFilter?.addEventListener('change', filterPolicies);
    industryFilter?.addEventListener('change', filterPolicies);
    categoryFilter?.addEventListener('change', filterPolicies);
  }

  document.addEventListener('astro:page-load', setupFiltering);
  setupFiltering();
</script>