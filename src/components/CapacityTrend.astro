---
import { getCollection } from 'astro:content';

const lang = Astro.currentLocale || 'zh';
const facilities = await getCollection(
  lang === 'en' ? 'facilities_en' : 'facilities_zh'
);

// Aggregate data by year
const operationalMap = new Map<number, number>(); // For operational facilities only
const pipelineMap = new Map<number, number>(); // For all projects

facilities.forEach((f) => {
  const year = f.data.operation;
  const numYear = typeof year === 'string' ? parseInt(year) : year;
  
  if (numYear && numYear >= 1970 && numYear <= 2040) {
    const cap = f.data.estimatedCapacity || 0;
    const status = f.data.status;
    const isOperational = status === '运行中' || status === 'Operational';
    
    if (isOperational) {
      operationalMap.set(numYear, (operationalMap.get(numYear) || 0) + cap);
    }
    pipelineMap.set(numYear, (pipelineMap.get(numYear) || 0) + cap);
  }
});

// Generate continuous year range for smoother chart
const startYear = 1970;
const endYear = 2040;
const currentYear = new Date().getFullYear();
const trendYears = [];
for (let y = startYear; y <= endYear; y++) {
  trendYears.push(y);
}

let cumulativeOperational = 0;
let cumulativePipeline = 0;

const chartData = trendYears.map((year) => {
  cumulativeOperational += operationalMap.get(year) || 0;
  cumulativePipeline += pipelineMap.get(year) || 0;
  return { 
    year, 
    operational: year <= currentYear ? cumulativeOperational.toFixed(1) : null,
    pipeline: cumulativePipeline.toFixed(1)
  };
});

const totalCapacity = cumulativePipeline.toFixed(1);
const operationalFacilities = facilities.filter(
  (f) => f.data.status === '运行中' || f.data.status === 'Operational'
);
const operationalCount = operationalFacilities.length;
const operationalCapacity = operationalFacilities.reduce((acc, f) => acc + (f.data.estimatedCapacity || 0), 0).toFixed(1);

const constructionFacilities = facilities.filter(
  (f) => f.data.status === '建设中' || f.data.status === 'Under construction'
);
const constructionCount = constructionFacilities.length;
const constructionCapacity = constructionFacilities.reduce((acc, f) => acc + (f.data.estimatedCapacity || 0), 0).toFixed(1);
---

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16">
  <!-- Stats Counter -->
  <div class="lg:col-span-1 space-y-6">
    <div
      class="p-8 bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden"
    >
      <div class="absolute -right-4 -bottom-4 opacity-5 text-blue-600">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="120"
          height="120"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          ><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg
        >
      </div>
      <h3
        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4"
      >
        {
          lang === 'zh'
            ? '全球累计产能 (2040估)'
            : 'Global Capacity (2040 Est.)'
        }
      </h3>
      <div class="text-5xl font-black text-emerald-600 mb-2">
        {totalCapacity}
        <span class="text-sm text-slate-400 font-bold uppercase">Mtpa</span>
      </div>
      <p class="text-xs text-slate-500 font-medium">
        {
          lang === 'zh'
            ? '基于 IEA 2025 项目库的各阶段产能预测加总。'
            : 'Projected cumulative capacity based on IEA 2025 pipeline data.'
        }
      </p>
    </div>

    <div
      class="p-8 bg-slate-900 rounded-3xl text-white shadow-xl relative overflow-hidden"
    >
      <div class="absolute -right-4 -bottom-4 opacity-10">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="120"
          height="120"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          ><path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
          ></path></svg
        >
      </div>
      <h3
        class="text-xs font-black text-blue-400 uppercase tracking-widest mb-4"
      >
        {lang === 'zh' ? '在运设施 / 规模' : 'Operational Facilities / Cap'}
      </h3>
      <div class="flex items-baseline gap-2 mb-2">
        <div class="text-5xl font-black tracking-tighter">
          {operationalCount}<span class="text-xs ml-1 opacity-40 font-bold">{lang === 'zh' ? '个' : ''}</span>
        </div>
        <div class="text-xl font-bold text-blue-400">/ {operationalCapacity} <span class="text-[10px] uppercase">Mtpa</span></div>
      </div>
      
      <div class="pt-4 border-t border-white/10">
        <h3 class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-1">
          {lang === 'zh' ? '在建设施 / 规模' : 'Under Construction / Cap'}
        </h3>
        <div class="flex items-baseline gap-2">
          <div class="text-2xl font-black text-emerald-400">
            {constructionCount}<span class="text-[9px] ml-0.5 opacity-40 font-bold">{lang === 'zh' ? '个' : ''}</span>
          </div>
          <div class="text-sm font-bold text-emerald-600">
            / {constructionCapacity} <span class="text-[10px] uppercase">Mtpa</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Card -->
  <div
    class="lg:col-span-2 p-8 bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm"
  >
    <div class="flex justify-between items-start mb-8">
      <div>
        <h3
          class="text-lg font-black dark:text-white mb-1 uppercase tracking-tight"
        >
          {
            lang === 'zh'
              ? '全球捕集能力增长趋势'
              : 'Capture Capacity Growth Trend'
          }
        </h3>
        <p
          class="text-[10px] text-slate-400 font-bold uppercase tracking-widest"
        >
          Global Cumulative Capacity (Mtpa) 1970 - 2040
        </p>
      </div>
      <div
        class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-[10px] font-black uppercase tracking-widest border border-blue-100 shadow-sm"
      >
        IEA 2025 Intelligence
      </div>
    </div>

    <div class="h-[300px] w-full">
      <canvas
        id="capacityChart"
        data-values={JSON.stringify(chartData)}
        data-label-op={lang === 'zh' ? '在运设施' : 'Operational'}
        data-label-pipe={lang === 'zh' ? '总规划 (含计划中)' : 'Total Pipeline'}></canvas>
    </div>
  </div>
</div>

<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script is:inline>
  function initCapacityChart() {
    const canvas = document.getElementById('capacityChart');
    if (!canvas) return;

    // Clear previous instance if exists
    const existingChart = Chart.getChart(canvas);
    if (existingChart) {
      existingChart.destroy();
    }

    try {
      const rawData = JSON.parse(canvas.dataset.values || '[]');
      if (rawData.length === 0) return;

      const labels = rawData.map(d => d.year);
      const opData = rawData.map(d => d.operational === null ? null : parseFloat(d.operational));
      const pipeData = rawData.map(d => parseFloat(d.pipeline));

      new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: canvas.dataset.labelOp,
              data: opData,
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              fill: true,
              tension: 0.3,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 6,
              spanGaps: false, // Ensure line stops at current year
            },
            {
              label: canvas.dataset.labelPipe,
              data: pipeData,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.05)',
              fill: true,
              tension: 0.3,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 6,
            }
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: { 
              display: true,
              position: 'top',
              align: 'end',
              labels: {
                boxWidth: 12,
                usePointStyle: true,
                font: { size: 10 }
              }
            },
            tooltip: {
              padding: 10,
              backgroundColor: '#0f172a',
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 }, color: '#94a3b8', maxTicksLimit: 10 },
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(148, 163, 184, 0.1)' },
              ticks: { font: { size: 10 }, color: '#94a3b8' },
            },
          },
        },
      });
    } catch (e) {
      console.error('Failed to init capacity chart:', e);
    }
  }

  // Astro page-load support
  document.addEventListener('astro:page-load', initCapacityChart);
  // Initial load
  if (document.readyState === 'complete') {
    initCapacityChart();
  } else {
    window.addEventListener('load', initCapacityChart);
  }
</script>
