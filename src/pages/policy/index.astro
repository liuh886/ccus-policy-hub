---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import PolicyCard from '../../components/PolicyCard.astro';
import countryData from '../../data/countries.json';

// 只获取中文政策
const policies = await getCollection('policies_zh');

// Country name mapping logic
const countryMap: Record<string, any> = countryData;

// Category translation and logic
const categoryMap: Record<string, string> = {
  'Economic Incentive': '经济激励',
  'Regulatory Framework': '法律监管',
  'Market Mechanism': '市场机制',
  'Strategic Guidance': '战略引导',
  'Technical Standard': '技术规范',
  'Economic Incentives': '经济激励',
  'Legal & Regulatory': '法律监管',
  'Market Mechanisms': '市场机制',
  'Regulatory': '法律监管',
};

const uniqueCountries = Array.from(new Set(policies.map((p) => p.data.country)))
  .sort()
  .map(canon => ({
    canon,
    display: countryMap[canon]?.zh || canon
  }));
const uniqueSectors = Array.from(new Set(policies.flatMap((p) => p.data.sectors || []))).sort();
const uniqueCategories = Array.from(new Set(policies.map((p) => categoryMap[p.data.category] || p.data.category))).sort();
---

<Layout
  title="政策数据库"
  description="检索全球主要的 CCUS 政策与法规，涵盖法律监管、经济激励、市场机制、战略引导及技术标准五大维度。"
  keywords="CCUS 政策, 碳捕集法规, 碳封存激励, 气候政策数据库"
>
  <div class="mb-10">
    <div class="max-w-2xl mb-8">
      <h1 class="text-4xl font-black mb-4 dark:text-white">政策数据库</h1>
      <p class="text-slate-600 dark:text-slate-400">
        收录全球主要经济体的 CCUS
        相关政策，涵盖法律监管、经济激励、市场机制、战略引导及技术标准五大维度。
      </p>
    </div>

    <div
      class="flex flex-col md:flex-row gap-4 bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm"
    >
      <div class="flex-grow relative">
        <input
          type="text"
          id="search-input"
          placeholder="搜索政策标题、内容或标签..."
          class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all dark:text-white"
        />
        <svg
          class="absolute left-3 top-2.5 text-slate-400"
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
          ></path></svg
        >
      </div>

      <select
        id="country-filter"
        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"
      >
        <option value="">所有国家</option>
        {uniqueCountries.map((c) => <option value={c.canon}>{c.display}</option>)}
      </select>

      <select
        id="industry-filter"
        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"
      >
        <option value="">所有行业</option>
        {uniqueSectors.map((sector) => <option value={sector}>{sector}</option>)}
      </select>

      <select
        id="category-filter"
        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"
      >
        <option value="">所有类型</option>
        {uniqueCategories.map((cat) => <option value={cat}>{cat}</option>)}
      </select>

      <button
        id="ranking-toggle"
        class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2"        
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
        <span>加权排名</span>
      </button>
    </div>

    <!-- Weighted Ranking Sliders (Initially Hidden) -->
    <div
      id="ranking-controls"
      class="hidden mt-4 p-6 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-800 animate-in fade-in slide-in-from-top-4 duration-300"
    >
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xs font-black uppercase tracking-widest text-blue-600">自定义评价权重 (FSRTM 5.0)</h3>
        <button id="reset-weights" class="text-[10px] font-black uppercase text-slate-400 hover:text-blue-600">重置比例</button>      
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
        {[
          { id: 'weight-incentive', label: '经济激励', color: 'bg-emerald-500', key: 'incentive' },
          { id: 'weight-statutory', label: '法律监管', color: 'bg-blue-500', key: 'statutory' },
          { id: 'weight-market', label: '市场机制', color: 'bg-amber-500', key: 'market' },
          { id: 'weight-strategic', label: '战略引导', color: 'bg-purple-500', key: 'strategic' },
          { id: 'weight-mrv', label: '技术规范', color: 'bg-slate-500', key: 'mrv' }
        ].map(w => (
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-[10px] font-bold text-slate-500 uppercase">{w.label}</span>
              <span class={`weight-val text-[10px] font-mono font-black ${w.color.replace('bg-', 'text-')}`} id={`${w.id}-val`}>20%</span>
            </div>
            <input
              type="range"
              id={w.id}
              min="0"
              max="100"
              value="20"
              class={`w-full h-1.5 ${w.color} rounded-lg appearance-none cursor-pointer accent-blue-600`}
            />
          </div>
        ))}
      </div>
      <p class="mt-6 text-[9px] font-medium text-slate-400 italic text-center">系统将根据您设定的权重，实时计算各项政策的综合得分并重新排序。</p>
    </div>
  </div>

  <div
    id="policy-grid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
  >
    {
      policies
        .sort((a, b) => b.data.year - a.data.year)
        .map((policy) => {
          const displayCategory = categoryMap[policy.data.category] || policy.data.category;
          return (
            <div
              class="policy-item"
              data-title={policy.data.title}
              data-country={policy.data.country}
              data-category={displayCategory}
              data-sectors={policy.data.sectors?.join(',') || ''}
              data-year={policy.data.year}
              data-analysis={JSON.stringify({
                incentive: policy.data.analysis?.incentive?.score || 0,
                statutory: policy.data.analysis?.statutory?.score || 0,
                market: policy.data.analysis?.market?.score || 0,
                strategic: policy.data.analysis?.strategic?.score || 0,
                mrv: policy.data.analysis?.mrv?.score || 0
              })}
            >
              <PolicyCard policy={policy} lang="zh" />
            </div>
          )
        })
    }
  </div>

  <div id="no-results" class="hidden py-20 text-center">
    <p class="text-slate-500">未找到符合条件的政策。</p>
  </div>
</Layout>

<script>
  function setupFiltering() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const countryFilter = document.getElementById('country-filter') as HTMLSelectElement;
    const industryFilter = document.getElementById('industry-filter') as HTMLSelectElement;
    const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
    const rankingToggle = document.getElementById('ranking-toggle');
    const rankingControls = document.getElementById('ranking-controls');
    const resetWeights = document.getElementById('reset-weights');
    const noResults = document.getElementById('no-results');

    const weightSliders = ['incentive', 'statutory', 'market', 'strategic', 'mrv'].map(k => ({
      key: k,
      slider: document.getElementById(`weight-${k}`) as HTMLInputElement,
      val: document.getElementById(`weight-${k}-val`) as HTMLElement
    }));

    let isRankingMode = false;

    function getWeights() {
      const weights: Record<string, number> = {};
      let total = 0;
      weightSliders.forEach(w => {
        const v = parseInt(w.slider.value);
        weights[w.key] = v;
        total += v;
      });
      if (total === 0) return weights;
      Object.keys(weights).forEach(k => weights[k] = weights[k] / total);
      return weights;
    }

    function updateWeightLabels() {
      const weights = getWeights();
      weightSliders.forEach(w => {
        const pct = Math.round((weights[w.key] || 0) * 100);
        w.val.innerText = `${pct}%`;
      });
    }

    function filterAndSortPolicies() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const country = countryFilter?.value || '';
      const industry = industryFilter?.value || '';
      const category = categoryFilter?.value || '';
      const weights = getWeights();

      const items = Array.from(document.querySelectorAll('.policy-item'));
      let visibleCount = 0;

      const scoredItems = items.map(item => {
        const htmlItem = item as HTMLElement;
        const title = htmlItem.dataset.title?.toLowerCase() || '';
        const itemCountry = htmlItem.dataset.country || '';
        const itemCategory = htmlItem.dataset.category || '';
        const itemSectors = htmlItem.dataset.sectors || '';
        const year = parseInt(htmlItem.dataset.year || '0');
        const analysis = JSON.parse(htmlItem.dataset.analysis || '{}');

        const matchesSearch = title.includes(searchTerm);
        const matchesCountry = !country || itemCountry === country;
        const matchesCategory = !category || itemCategory === category;
        const matchesIndustry = !industry || itemSectors.split(',').includes(industry);

        const isVisible = matchesSearch && matchesCountry && matchesCategory && matchesIndustry;

        let weightedScore = 0;
        if (isRankingMode) {
          Object.entries(weights).forEach(([k, w]) => {
            weightedScore += (analysis[k] || 0) * w;
          });
        }

        return { item: htmlItem, isVisible, weightedScore, year };
      });

      scoredItems.sort((a, b) => {
        if (isRankingMode) {
          return b.weightedScore - a.weightedScore || b.year - a.year;
        }
        return b.year - a.year;
      });

      scoredItems.forEach((si, index) => {
        if (si.isVisible) {
          si.item.style.display = 'block';
          si.item.style.order = index.toString();
          visibleCount++;

          let badge = si.item.querySelector('.weighted-score-badge');
          if (isRankingMode) {
            if (!badge) {
              badge = document.createElement('div');
              badge.className = 'weighted-score-badge absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] font-black w-8 h-8 flex items-center justify-center rounded-full border-2 border-white shadow-lg z-10 animate-in zoom-in duration-300';
              si.item.style.position = 'relative';
              si.item.appendChild(badge);
            }
            badge.textContent = Math.round(si.weightedScore).toString();
          } else if (badge) {
            badge.remove();
          }
        } else {
          si.item.style.display = 'none';
        }
      });

      if (noResults) {
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
      }
    }

    rankingToggle?.addEventListener('click', () => {
      isRankingMode = !isRankingMode;
      rankingControls?.classList.toggle('hidden');
      rankingToggle.classList.toggle('bg-blue-600');
      rankingToggle.classList.toggle('bg-slate-800');
      filterAndSortPolicies();
    });

    weightSliders.forEach(w => {
      w.slider.addEventListener('input', () => {
        updateWeightLabels();
        filterAndSortPolicies();
      });
    });

    resetWeights?.addEventListener('click', () => {
      weightSliders.forEach(w => w.slider.value = '20');
      updateWeightLabels();
      filterAndSortPolicies();
    });

    searchInput?.addEventListener('input', filterAndSortPolicies);
    countryFilter?.addEventListener('change', filterAndSortPolicies);
    industryFilter?.addEventListener('change', filterAndSortPolicies);
    categoryFilter?.addEventListener('change', filterAndSortPolicies);
  }

  document.addEventListener('astro:page-load', setupFiltering);
  setupFiltering();
</script>