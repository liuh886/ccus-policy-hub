---
import { getCollection } from 'astro:content';

const lang = Astro.currentLocale || 'zh';
const facilities = await getCollection(
  lang === 'en' ? 'facilities_en' : 'facilities_zh'
);

// Aggregate data by year
const yearMap = new Map<number, number>();
const futureMap = new Map<number, number>();

facilities.forEach((f) => {
  const year = f.data.commencementYear;
  const isOperational = f.data.status === '运行中' || f.data.status === 'Operational';
  const isConstruction = f.data.status === '在建' || f.data.status === 'Under construction';
  
  if (year && year >= 1970 && year <= 2050) {
    if (isOperational || isConstruction) {
      yearMap.set(year, (yearMap.get(year) || 0) + f.data.capacity);
    } else {
      futureMap.set(year, (futureMap.get(year) || 0) + f.data.capacity);
    }
  }
});

const currentYear = new Date().getFullYear();
const sortedYears = Array.from(new Set([...yearMap.keys(), ...futureMap.keys()])).sort((a, b) => a - b);

let cumulative = 0;
let futureCumulative = 0;

const chartData = sortedYears.map((year) => {
  cumulative += yearMap.get(year) || 0;
  // Future capacity includes operational + planned
  futureCumulative = cumulative + Array.from(futureMap.entries())
    .filter(([y]) => y <= year)
    .reduce((sum, [_, cap]) => sum + cap, 0);
    
  return { 
    year, 
    value: cumulative.toFixed(1),
    futureValue: futureCumulative.toFixed(1)
  };
});

const totalCapacity = cumulative.toFixed(1);
const totalPotential = futureCumulative.toFixed(1);
const operationalCount = facilities.filter(
  (f) => f.data.status === '运行中' || f.data.status === 'Operational'
).length;
const operationalCapacity = facilities
  .filter((f) => f.data.status === '运行中' || f.data.status === 'Operational')
  .reduce((sum, f) => sum + f.data.capacity, 0)
  .toFixed(1);

const constructionCount = facilities.filter(
  (f) => f.data.status === '在建' || f.data.status === 'Under construction'
).length;
const constructionCapacity = facilities
  .filter((f) => f.data.status === '在建' || f.data.status === 'Under construction')
  .reduce((sum, f) => sum + f.data.capacity, 0)
  .toFixed(1);
---

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16">
  <!-- Stats Counter -->
  <div class="lg:col-span-1 space-y-6">
    <div
      class="p-8 bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden"
    >
      <div class="absolute -right-4 -bottom-4 opacity-5 text-blue-600">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="120"
          height="120"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          ><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg
        >
      </div>
      <h3
        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4"
      >
        {
          lang === 'zh'
            ? '全球总潜力产能 (2050)'
            : 'Global Potential (2050)'
        }
      </h3>
      <div class="text-5xl font-black text-emerald-600 mb-2">
        {totalPotential}
        <span class="text-sm text-slate-400 font-bold uppercase">Mtpa</span>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-slate-100 dark:border-slate-800">
        <div>
          <div class="text-[10px] font-black text-slate-400 uppercase mb-1">{lang === 'zh' ? '在运总产能' : 'Op. Capacity'}</div>
          <div class="text-lg font-black dark:text-white text-blue-600">{totalCapacity} <span class="text-[10px] text-slate-400">Mtpa</span></div>
        </div>
        <div>
          <div class="text-[10px] font-black text-slate-400 uppercase mb-1">{lang === 'zh' ? '在建总产能' : 'Const. Capacity'}</div>
          <div class="text-lg font-black dark:text-white">{constructionCapacity} <span class="text-[10px] text-slate-400">Mtpa</span></div>
        </div>
      </div>
    </div>

    <div
      class="p-8 bg-slate-900 rounded-3xl text-white shadow-xl relative overflow-hidden"
    >
      <div class="absolute -right-4 -bottom-4 opacity-10">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="120"
          height="120"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          ><path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
          ></path></svg
        >
      </div>
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">
          {lang === 'zh' ? '在运 / 在建设施' : 'Op. / Const. Facilities'}
        </h3>
      </div>
      <div class="flex items-baseline gap-2 mb-2">
        <div class="text-5xl font-black tracking-tighter">
          {operationalCount}
        </div>
        <div class="text-xl font-bold text-slate-500">/ {constructionCount}</div>
      </div>
      <p class="text-xs text-slate-400">
        {
          lang === 'zh'
            ? '当前全球已商业化运行及正在建设中的项目数量。'
            : 'Number of projects in commercial operation and under construction.'
        }
      </p>
    </div>
  </div>

  <!-- Chart Card -->
  <div
    class="lg:col-span-2 p-8 bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm"
  >
    <div class="flex justify-between items-start mb-8">
      <div>
        <h3
          class="text-lg font-black dark:text-white mb-1 uppercase tracking-tight"
        >
          {
            lang === 'zh'
              ? '全球捕集能力增长趋势'
              : 'Capture Capacity Growth Trend'
          }
        </h3>
        <p
          class="text-[10px] text-slate-400 font-bold uppercase tracking-widest"
        >
          Global Cumulative Capacity (Mtpa) 1970 - 2050
        </p>
      </div>
      <div
        class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-[10px] font-black uppercase tracking-widest border border-blue-100 shadow-sm"
      >
        IEA 2025 Intelligence
      </div>
    </div>

    <div class="h-[300px] w-full">
      <canvas
        id="capacityChart"
        data-values={JSON.stringify(chartData)}
        data-label={lang === 'zh' ? '累计产能' : 'Cumulative'}></canvas>
    </div>
  </div>
</div>

<script>
  import Chart from 'chart.js/auto';

  function initChart() {
    const canvas = document.getElementById(
      'capacityChart'
    ) as HTMLCanvasElement;
    if (!canvas) return;

    const data = JSON.parse(canvas.dataset.values || '[]');
    const label = canvas.dataset.label;

    new Chart(canvas, {
      type: 'line',
      data: {
        labels: data.map((d: any) => d.year),
        datasets: [
          {
            label: label,
            data: data.map((d: any) => d.value),
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 0,
            pointHoverRadius: 6,
          },
          {
            label: 'Potential (Incl. Planned)',
            data: data.map((d: any) => d.futureValue),
            borderColor: '#10b981',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            fill: false,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4,
          }
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            padding: 12,
            backgroundColor: '#0f172a',
            titleFont: { size: 14, weight: 'bold' },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { font: { size: 10 }, color: '#94a3b8' },
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(148, 163, 184, 0.1)' },
            ticks: { font: { size: 10 }, color: '#94a3b8' },
          },
        },
      },
    });
  }

  document.addEventListener('astro:page-load', initChart);
  initChart();
</script>
