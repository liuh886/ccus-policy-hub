---
import { ui, defaultLang } from '../i18n/ui';

interface Props {
  lang?: 'zh' | 'en';
}

const lang = Astro.props.lang ?? (Astro.currentLocale as 'zh' | 'en' | undefined) ?? defaultLang;
const t = (key: keyof typeof ui['zh']) => ui[lang as keyof typeof ui][key] || ui[defaultLang][key];
const isEn = lang === 'en';
const BASE = '/ccus-policy-hub';
const compareHref = isEn ? `${BASE}/en/compare/` : `${BASE}/compare/`;
---
<div id="compare-drawer" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 hidden animate-in slide-in-from-bottom-8 duration-500">
  <div class="bg-slate-900/95 dark:bg-black/90 text-white px-8 py-5 rounded-[2rem] shadow-[0_20px_50px_rgba(0,0,0,0.3)] border border-white/10 flex items-center gap-8 backdrop-blur-2xl">
    <div class="flex items-center gap-3">
      <div class="relative flex items-center justify-center">
        <div class="bg-blue-600 text-[10px] font-black w-7 h-7 flex items-center justify-center rounded-full z-10 shadow-lg shadow-blue-500/40 border border-white/20" id="compare-count">0</div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-20"></div>
      </div>
      <div class="flex flex-col">
        <span class="text-[10px] font-black uppercase tracking-widest text-blue-400 leading-none mb-1">Benchmarking</span>
        <span class="text-sm font-bold text-white leading-none">{isEn ? 'policies selected' : '项政策已选'}</span>
      </div>
    </div>
    
    <div class="h-8 w-px bg-white/10"></div>
    
    <div class="flex items-center gap-6">
      <button id="clear-compare" class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-red-400 transition-colors cursor-pointer">{isEn ? 'Reset' : '重置'}</button>
      <a href={compareHref} class="bg-white text-slate-900 px-6 py-2.5 rounded-2xl text-xs font-black uppercase tracking-[0.1em] hover:bg-blue-500 hover:text-white transition-all shadow-xl active:scale-95">
        {t('compare.btn')}
      </a>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'compare-list';
  const LEGACY_KEY = 'compare-policies';

  function safeParseList(value: string | null) {
    try {
      const parsed = JSON.parse(value || '[]');
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function getCompareList() {
    const current = safeParseList(localStorage.getItem(STORAGE_KEY));
    const legacy = safeParseList(localStorage.getItem(LEGACY_KEY));

    if (legacy.length === 0) return current;

    const merged = Array.from(new Set([...current, ...legacy]));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
    localStorage.removeItem(LEGACY_KEY);
    return merged;
  }

  function updateDrawer() {
    const drawer = document.getElementById('compare-drawer');
    const countEl = document.getElementById('compare-count');
    const list = getCompareList();
    
    if (countEl) countEl.innerText = list.length.toString();
    
    if (list.length > 0) {
      drawer?.classList.remove('hidden');
      drawer?.classList.add('flex');
    } else {
      drawer?.classList.add('hidden');
      drawer?.classList.remove('flex');
    }

    // 同步所有页面上的复选框
    document.querySelectorAll('.compare-checkbox').forEach((cb) => {
      const checkbox = cb as HTMLInputElement;
      checkbox.checked = list.includes(checkbox.dataset.id || '');
    });
  }

  // 监听复选框变化 (使用委托)
  document.addEventListener('change', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.classList.contains('compare-checkbox')) {
      let list = getCompareList();
      const id = target.dataset.id;
      if (!id) return;
      
      if (target.checked) {
        if (!list.includes(id)) {
          if (list.length >= 5) {
            const isEn = document.documentElement.lang === 'en';
            alert(isEn ? 'You can compare up to 5 policies.' : '最多只能同时对比 5 项政策');
            target.checked = false;
            return;
          }
          list.push(id);
        }
      } else {
        list = list.filter((i: string) => i !== id);
      }
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      // 发送自定义事件以便同窗口监听
      window.dispatchEvent(new CustomEvent('compare-updated'));
      updateDrawer();
    }
  });

  // 监听清除按钮
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.id === 'clear-compare') {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(LEGACY_KEY);
      window.dispatchEvent(new CustomEvent('compare-updated'));
      updateDrawer();
    }
  });

  if (!(window as any).__ccusCompareDrawerBound) {
    // 初始加载和路由跳转后加载
    window.addEventListener('load', updateDrawer);
    document.addEventListener('astro:page-load', updateDrawer);
    // 监听多标签同步
    window.addEventListener('storage', updateDrawer);
    (window as any).__ccusCompareDrawerBound = true;
  }
  updateDrawer();
</script>
